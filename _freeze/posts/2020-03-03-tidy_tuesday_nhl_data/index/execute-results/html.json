{
  "hash": "856fd20a9b232607b1805e57d1b2ed01",
  "result": {
    "markdown": "---\ntitle: \"Tidy Tuesday: NHL Goalscorers\"\nauthor: Jonny Law\ndate: 2020-03-03\nslug: tidy-tuesday\noutput: distill::distill_article\ncategories:\n  - R\n  - tidy-tuesday\n---\n\n\n\n\nFirst install the Tidy Tuesday R package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(\"remotes\")\nremotes::install_github(\"thebioengineer/tidytuesdayR\")\n```\n:::\n\n\nThe data for this Tuesday can be downloaded using `tt_load`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata <- tidytuesdayR::tt_load('2020-03-03')\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDownloading file 1 of 3: `game_goals.csv`\n\tDownloading file 2 of 3: `season_goals.csv`\n\tDownloading file 3 of 3: `top_250.csv`\n```\n:::\n:::\n\n\nUnfortunately this only grabbed one file - the top 250 goalscorers. First look at this file.\n\n# Top Career Goalscorers\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntuesdata$top_250 %>% \n  top_n(30, wt = total_goals) %>% \n  mutate(player = forcats::fct_reorder(player, total_goals)) %>% \n  ggplot(aes(x = player, y = total_goals)) +\n  geom_col() +\n  coord_flip() \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n# Average goals per season\n\n\n::: {.cell}\n\n```{.r .cell-code}\nparse_end_year <- function(years) {\n  end_tens <- substr(years, 6, 7)\n  possible_end <- as.numeric(paste0(substr(years, 1, 2), end_tens))\n  start <- as.numeric(substr(years, 1, 4))\n  if (possible_end - start > 0) {\n    possible_end\n  } else {\n    as.numeric(paste0(20, end_tens))\n  }\n}\n\noptions(scipen = 99)\ntuesdata$top_250 %>%\n  rowwise() %>% \n  mutate(\n    yr_end = parse_end_year(years),\n    seasons = yr_end - yr_start,\n    average_goals_per_season = total_goals / seasons,\n    decade = cut(yr_start, breaks = seq(1920, 2020, by = 10), dig.lab = 10)\n  ) %>% \n  ungroup() %>% \n  # group_by(decade) %>% \n  mutate(player = forcats::fct_reorder(player, average_goals_per_season)) %>% \n  top_n(30, wt = average_goals_per_season) %>%\n  ggplot(aes(x = player, y = average_goals_per_season, fill = active)) +\n  geom_col() +\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n\n```{.r .cell-code}\n  # facet_wrap( ~ decade, scales = \"free_y\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ngoals_per_season <- tuesdata$top_250 %>%\n  rowwise() %>%\n  mutate(\n    yr_end = parse_end_year(years),\n    seasons = yr_end - yr_start,\n    average_goals_per_season = total_goals / seasons,\n    decade = cut(\n      yr_start,\n      breaks = seq(1920, 2020, by = 10),\n      dig.lab = 10\n    )\n  ) %>%\n  ungroup()\n\nggplot() +\n  geom_point(data = goals_per_season,\n             aes(x = seasons, y = average_goals_per_season)) +\n  ggrepel::geom_label_repel(data = top_n(goals_per_season, 10, total_goals), aes(x = seasons, y = average_goals_per_season, label = paste(player, total_goals), fill = active)) +\n  xlab(\"Total Seasons in NHL\") +\n  ylab(\"Average Goals per Season\") +\n  theme_minimal() +\n  labs(title = tools::toTitleCase(\"average goals per season and total number of seasons \\nfor the top 250 NHL Goal Scorers\"), subtitle = \"Top 10 all-time goal scorers are labelled\") +\n  theme(legend.position = c(0.9, 0.9), legend.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(\"goals_per_season.png\")\n```\n:::\n\n\n# Game Goals\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngame_goals <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-03/game_goals.csv')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhighlighted_players <- tuesdata$top_250 %>% \n  filter(player %in% c(\"Alex Ovechkin\", \"Wayne Gretzky\")) %>% \n  select(player, yr_start)\n\ncumulative_goals <- game_goals %>% \n  mutate(age_years = as.numeric(substr(age, 1, 2))) %>% \n  group_by(player, age_years) %>% \n  summarise(goals_per_season = sum(goals)) %>% \n  arrange(player, age_years) %>% \n  inner_join(tuesdata$top_250, by = \"player\") %>% \n  mutate(cumulative_goals = cumsum(goals_per_season))\n\nggplot(cumulative_goals, aes(x = age_years, y = cumulative_goals)) +\n  geom_line(data = cumulative_goals,\n            aes(x = age_years, y = cumulative_goals, group = player),\n            alpha = 0.2) +\n  geom_line(\n    data = cumulative_goals %>% inner_join(highlighted_players, by = \"player\"),\n    aes(x = age_years, y = cumulative_goals, colour = player)\n  ) +\n  geom_label_repel(\n    data =\n      cumulative_goals %>%\n      inner_join(highlighted_players, by = \"player\") %>% \n      filter(age_years == 30),\n    aes(\n      x = age_years,\n      y = cumulative_goals,\n      label = player,\n      colour = player\n    )\n  ) +\n  xlab(\"Player Age\") +\n  ylab(\"Total Goals\") +\n  theme_minimal() +\n  labs(title = \"Cumulative Goals in the NHL by Age\", subtitle = \"Data from 42 of the all time 250 NHL scorers who started their career since game-level \\ndata became available in 1979/80 season.\") +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(\"cumulative_goals.png\")\n```\n:::\n\n\n## Post some results to Twitter\n\nNow use the [twitteR](https://cran.r-project.org/web/packages/twitteR/README.html) library to post the plots directly to Twitter without leaving R. You must connect to the Twitter API using OAuth as described in the README for twitteR, I set the Twitter application keys in my `.Renviron` file which is never committed to public version control (this can be easily edited using `usethis::edit_r_environ()`).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(twitteR)\noauth <- setup_twitter_oauth(\n  Sys.getenv(\"TWITTER_API_KEY\"),\n  Sys.getenv(\"TWITTER_API_SECRET_KEY\"),\n  access_token = Sys.getenv(\"TWITTER_ACCESS_TOKEN\"),\n  access_secret = Sys.getenv(\"TWITTER_ACCESS_TOKEN_SECRET\")\n)\n```\n:::\n\n\nWith twitteR we can get the most recent #tidytuesday posts\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsearchTwitter('#tidytuesday', n = 10)\n```\n:::\n\n\nUnfortunately the twitteR API (I think people tend to use [rtweet](https://rtweet.info) now!) is a little outdated and requires tweets to be less than 140 characters (however this can be bypassed using `bypassCharLimit = TRUE`) and we can't post multiple images in the same tweet using the `mediaPath` argument. So unfortunately I had to resort to posting my graphs manually!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nupdateStatus(\n  \"Can Alex Ovechkin overhaul Wayne Gretzky's all time NHL goal scoring record. It appears as if Wayne slowed down in the latter years of his career. #rstats #TidyTuesday\",\n  mediaPath = c(\"cumulative_goals.png\", \"goals_per_season.png\"),\n  bypassCharLimit = TRUE\n)\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}